<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoviTube â€” Movie Reviews (Cinematic)</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    :root{
      --primary-dark: #1a1a1a;
      --near-black: #121212;
      --off-white: #f5f5f5;
      --accent-red: #e63946;
      --dark-red: #b71c1c;
      --card-dark: #181818;
      --muted: #9a9a9a;
      --glass: rgba(255,255,255,0.03);
    }

    /* ---------- Global ---------- */
    html,body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--near-black);
      color: var(--off-white);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background 220ms ease;
    }

    a { text-decoration: none; }
    .container { max-width: 980px; }

    /* ---------- Navbar (MoviTube) ---------- */
    .navbar {
      background-color: var(--primary-dark) !important;
      padding-top: 0.8rem;
      padding-bottom: 0.8rem;
      transition: background 220ms ease;
    }
    .navbar-brand {
      color: var(--off-white) !important;
      font-weight: 800;
      font-size: 1.6rem;
      letter-spacing: .4px;
    }
    .navbar-nav .nav-link {
      color: var(--off-white) !important;
      transition: color 160ms ease;
    }
    .navbar-nav .nav-link:hover { color: var(--accent-red) !important; }
    .btn-primary { background-color: var(--accent-red); border-color: var(--dark-red); }
    .btn-primary:hover { background-color: var(--dark-red); }

    /* ---------- Cards & Layout ---------- */
    .dark-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      transition: transform 220ms ease, box-shadow 220ms ease;
    }
    .dark-card:hover { transform: translateY(-4px); box-shadow: 0 14px 36px rgba(0,0,0,0.7); }

    /* ---------- Poster Animation ---------- */
    #moviePoster {
      max-width: 230px;
      border-radius: 10px;
      display: block;
      margin: 0 auto 16px;
      opacity: 0;
      transform: translateY(8px) scale(.99);
      transition: transform 420ms cubic-bezier(.2,.9,.2,1), opacity 420ms ease;
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
    }
    #moviePoster.in-view {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    /* ---------- Star Rating (red stars) ---------- */
    #ratingStars { letter-spacing: 6px; display:inline-block; }
    .star-rating {
      font-size: 2.0rem;
      cursor: pointer;
      color: #333;
      display:inline-block;
      transition: transform 160ms ease, color 160ms ease, text-shadow 160ms ease;
      user-select: none;
      -webkit-user-select: none;
    }
    .star-rating:hover { transform: scale(1.12); color: var(--accent-red); text-shadow: 0 0 10px rgba(230,57,70,0.22); }
    .star-rating.selected {
      color: var(--accent-red);
      text-shadow: 0 0 12px rgba(230,57,70,0.85);
      transform: scale(1.08);
    }

    /* subtle hover for buttons */
    .btn {
      transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease;
    }
    .btn:active { transform: translateY(1px); }

    /* inputs / textarea */
    .form-control {
      background: #0f0f0f;
      border: 1px solid rgba(255,255,255,0.04);
      color: var(--off-white);
      border-radius: 8px;
    }
    .form-control::placeholder { color: var(--muted); }

    /* reviews list */
    #reviewsList .list-group-item {
      background: #0f0f0f;
      border: 1px solid rgba(255,255,255,0.03);
      border-radius: 8px;
      margin-bottom: 12px;
      padding: 12px 14px;
      color: var(--off-white);
      transition: transform 180ms ease, box-shadow 180ms ease;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    #reviewsList .list-group-item .meta { color: var(--muted); font-size: 0.85rem; }
    .rating-badge { color: var(--accent-red); font-weight:700; margin-right:8px; }

    /* review author (anonymous) pill */
    .pill {
      background: rgba(255,255,255,0.02);
      color: var(--muted);
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid rgba(255,255,255,0.02);
    }

    /* sorter & controls */
    .controls {
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-bottom: 10px;
    }
    .controls .form-select { width: 180px; background:#0f0f0f; color:var(--off-white); border-radius:8px; border:1px solid rgba(255,255,255,0.03); }

    /* load more */
    #loadMore {
      display:block;
      margin: 16px auto 0;
      padding: 10px 18px;
      border-radius: 10px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.04);
      color:var(--off-white);
    }
    #loadMore:hover { background: rgba(230,57,70,0.06); border-color: rgba(230,57,70,0.2); }

    /* empty state */
    .empty {
      color: var(--muted);
      text-align:center;
      padding: 20px 8px;
    }

    /* small responsive tweaks */
    @media (max-width: 576px){
      #moviePoster { max-width: 160px; }
      .controls { justify-content: center; margin-top:10px; }
    }

  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="Homepage.html"><i class="bi bi-film"></i> MoviTube</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="Genres Page.html">Genres</a></li>
          <li class="nav-item"><a class="nav-link" href="Watchlist Page.html">Watchlist</a></li>
          <li class="nav-item"><a class="nav-link active" href="Reviews Page.html">Reviews</a></li>
          <li class="nav-item"><a class="nav-link" href="Contact Page.html">Contact</a></li>
          <li class="nav-item"><a class="nav-link" href="About Us Page.html">About Us</a></li>
        </ul>

        <form class="d-flex" action="Search Results Page.html" method="GET">
          <input class="form-control me-2" type="search" name="query" placeholder="Search Movies...">
          <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
        </form>
      </div>
    </div>
  </nav>

  <!-- PAGE CONTENT -->
  <div class="container py-5">
    <h2 class="text-center mb-4" style="font-weight:700;">ðŸŽ¬ Movie Reviews</h2>

    <!-- Search Card -->
    <div class="dark-card mb-4">
      <div class="row g-3 align-items-center">
        <div class="col-md-8 col-12">
          <input id="movieSearch" class="form-control" placeholder="Search for a movie..." />
        </div>
        <div class="col-md-4 col-12 d-grid">
          <button id="findMovie" class="btn btn-primary">Find Movie</button>
        </div>
      </div>
    </div>

    <!-- Movie Info Card -->
    <div id="movieInfo" class="dark-card text-center mb-4" style="display:none;">
      <img id="moviePoster" alt="Movie Poster" />
      <h3 id="movieTitle" style="margin-bottom:6px;"></h3>
      <p id="movieYear" class="text-muted" style="margin-bottom:0;"></p>
    </div>

    <!-- Review Section Card -->
    <div id="reviewSection" class="dark-card" style="display:none;">
      <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
        <h5 style="margin:0;">Write an Anonymous Review</h5>

        <div class="controls">
          <label class="pill me-2" style="display:flex;align-items:center;">Sort</label>
          <select id="sortSelect" class="form-select form-select-sm">
            <option value="highest">Highest Rating</option>
            <option value="newest" selected>Newest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
      </div>

      <!-- Star Rating -->
      <div class="mb-3">
        <div id="ratingStars">â˜… â˜… â˜… â˜… â˜…</div>
      </div>

      <textarea id="reviewText" rows="3" class="form-control mb-3" placeholder="Your review..."></textarea>

      <div class="d-flex gap-2 flex-wrap">
        <button id="submitReview" class="btn btn-primary">Submit Review</button>
        <button id="clearReviews" class="btn btn-outline-secondary">Clear Reviews for This Movie</button>
      </div>

      <hr style="border-color: rgba(255,255,255,0.03); margin:18px 0;">

      <h5 style="margin-bottom:12px;">User Reviews</h5>

      <!-- Reviews list + load more -->
      <div id="reviewsContainer">
        <ul id="reviewsList" class="list-unstyled mb-0"></ul>
        <div id="emptyState" class="empty" style="display:none;">No reviews yet â€” be the first to leave one!</div>
        <button id="loadMore" style="display:none;">Load more reviews</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    // ========== Configuration ==========
    const apiKey = "fd0ac2a4"; // OMDB key (keep yours private in production)
    const REVIEWS_PER_BATCH = 5; // per user's choice (option B)

    // ========== State ==========
    let selectedRating = 0;
    const starsContainer = document.getElementById('ratingStars');
    const moviePoster = document.getElementById('moviePoster');
    const movieInfoDiv = document.getElementById('movieInfo');
    const reviewSection = document.getElementById('reviewSection');
    const reviewsList = document.getElementById('reviewsList');
    const loadMoreBtn = document.getElementById('loadMore');
    const emptyState = document.getElementById('emptyState');

    let currentMovieTitle = '';
    let currentReviews = [];
    let reviewsRenderedCount = 0;
    let currentSort = document.getElementById('sortSelect').value;

    // ---------- Utility ----------
    function saveReviewsFor(title, reviews) {
      localStorage.setItem('reviews::' + title, JSON.stringify(reviews));
    }
    function loadReviewsFor(title) {
      return JSON.parse(localStorage.getItem('reviews::' + title) || '[]');
    }

    // ---------- Stars Setup ----------
    function setupStars() {
      starsContainer.innerHTML = "â˜… â˜… â˜… â˜… â˜…".split(" ").map((s,i)=>`<span class="star-rating" data-value="${i+1}">â˜…</span>`).join('');
      document.querySelectorAll('.star-rating').forEach(star=>{
        star.addEventListener('mouseenter', ()=> {
          const val = parseInt(star.dataset.value);
          document.querySelectorAll('.star-rating').forEach((s,idx)=> {
            s.classList.toggle('selected', idx < val);
          });
        });
        star.addEventListener('mouseleave', ()=> {
          // restore selection
          document.querySelectorAll('.star-rating').forEach((s,idx)=> {
            s.classList.toggle('selected', idx < selectedRating);
          });
        });
        star.addEventListener('click', ()=> {
          selectedRating = parseInt(star.dataset.value);
          document.querySelectorAll('.star-rating').forEach((s,idx)=> s.classList.toggle('selected', idx < selectedRating));
        });
      });
    }
    setupStars();

    // ---------- Movie Fetch & Display ----------
    document.getElementById('findMovie').addEventListener('click', async (e) => {
      e.preventDefault();
      const query = document.getElementById('movieSearch').value.trim();
      if(!query) return alert('Please enter a movie title.');
      try {
        const res = await fetch(`https://www.omdbapi.com/?apikey=${apiKey}&t=${encodeURIComponent(query)}`);
        const movie = await res.json();
        if(movie.Response === "False") return alert('Movie not found.');
        currentMovieTitle = movie.Title;
        document.getElementById('movieTitle').textContent = movie.Title;
        document.getElementById('movieYear').textContent = movie.Year ? 'Released: ' + movie.Year : '';
        // poster fade-in
        moviePoster.classList.remove('in-view');
        moviePoster.src = (movie.Poster && movie.Poster !== 'N/A') ? movie.Poster : 'https://via.placeholder.com/230x345?text=No+Poster';
        // ensure image onload adds in-view
        moviePoster.onload = () => { setTimeout(()=> moviePoster.classList.add('in-view'), 50); };

        // show sections
        movieInfoDiv.style.display = 'block';
        reviewSection.style.display = 'block';

        // load reviews
        currentReviews = loadReviewsFor(currentMovieTitle);
        reviewsRenderedCount = 0;
        currentSort = document.getElementById('sortSelect').value;
        renderReviews({ reset: true });
      } catch(err) {
        console.error(err);
        alert('Error fetching movie data. Check your network or API key.');
      }
    });

    // ---------- Render Reviews with Sorting & Pagination ----------
    function sortReviewsArray(arr, sortKey) {
      const copy = [...arr];
      if(sortKey === 'highest') {
        copy.sort((a,b)=> b.rating - a.rating || b.time - a.time);
      } else if(sortKey === 'newest') {
        copy.sort((a,b)=> b.time - a.time);
      } else if(sortKey === 'oldest') {
        copy.sort((a,b)=> a.time - b.time);
      }
      return copy;
    }

    function renderReviews({reset=false} = {}) {
      if(!currentMovieTitle) return;
      currentSort = document.getElementById('sortSelect').value;
      const sorted = sortReviewsArray(currentReviews, currentSort);
      if(reset) {
        reviewsList.innerHTML = '';
        reviewsRenderedCount = 0;
      }

      const start = reviewsRenderedCount;
      const end = Math.min(sorted.length, start + REVIEWS_PER_BATCH);
      const batch = sorted.slice(start, end);

      if(sorted.length === 0) {
        emptyState.style.display = 'block';
        loadMoreBtn.style.display = 'none';
        return;
      } else {
        emptyState.style.display = 'none';
      }

      batch.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        // structure: rating badge + content
        const left = document.createElement('div');
        left.style.minWidth = '86px';
        left.style.flex = '0 0 86px';
        left.style.display = 'flex';
        left.style.flexDirection = 'column';
        left.style.alignItems = 'flex-start';
        left.innerHTML = `<div class="rating-badge">${'â˜…'.repeat(item.rating)}</div><div class="meta pill" style="margin-top:8px;">Anonymous â€¢ ${new Date(item.time).toLocaleString()}</div>`;

        const right = document.createElement('div');
        right.style.flex = '1';
        right.innerHTML = `<div style="white-space:pre-wrap;">${escapeHtml(item.text)}</div>`;

        li.appendChild(left);
        li.appendChild(right);

        reviewsList.appendChild(li);
      });

      reviewsRenderedCount = end;
      // show/hide load more
      if(reviewsRenderedCount < sorted.length) {
        loadMoreBtn.style.display = 'block';
      } else {
        loadMoreBtn.style.display = 'none';
      }
    }

    // simple HTML escape to avoid injection in this simple app
    function escapeHtml(str) {
      return str.replace(/[&<>"'`]/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"`":'&#96;'}[m]));
    }

    // load more on click
    loadMoreBtn.addEventListener('click', ()=> renderReviews({ reset:false }));

    // sorting change
    document.getElementById('sortSelect').addEventListener('change', ()=> {
      // re-render from top using new sort
      renderReviews({ reset:true });
    });

    // ---------- Submit Review ----------
    document.getElementById('submitReview').addEventListener('click', ()=> {
      if(!currentMovieTitle) return alert('Please find a movie first.');
      const text = document.getElementById('reviewText').value.trim();
      if(!text) return alert('Please write a review before submitting.');
      if(selectedRating === 0) return alert('Please select a star rating.');

      // add review object with timestamp
      const reviewObj = { rating: selectedRating, text, time: Date.now() };
      currentReviews = loadReviewsFor(currentMovieTitle);
      currentReviews.push(reviewObj);
      saveReviewsFor(currentMovieTitle, currentReviews);

      // reset UI
      document.getElementById('reviewText').value = '';
      selectedRating = 0;
      document.querySelectorAll('.star-rating').forEach(s=> s.classList.remove('selected'));
      // refresh
      reviewsRenderedCount = 0;
      renderReviews({ reset:true });
    });

    // ---------- Clear Reviews (per movie) ----------
    document.getElementById('clearReviews').addEventListener('click', ()=> {
      if(!currentMovieTitle) return alert('No movie loaded.');
      if(!confirm('Clear all reviews for "' + currentMovieTitle + '"? This cannot be undone.')) return;
      localStorage.removeItem('reviews::' + currentMovieTitle);
      currentReviews = [];
      renderReviews({ reset:true });
    });

    // ---------- Init: If page loads with query param ?t=Movie+Title, auto-search ----------
    (function initFromQuery() {
      const params = new URLSearchParams(location.search);
      const t = params.get('t') || params.get('title');
      if(t) {
        document.getElementById('movieSearch').value = t;
        // small timeout so UI loads
        setTimeout(()=> document.getElementById('findMovie').click(), 250);
      }
    })();

    // Re-setup stars when DOM updates (helper in case)
    window.addEventListener('DOMContentLoaded', setupStars);
  </script>

  <!-- Bootstrap JS (optional for navbar toggler) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
